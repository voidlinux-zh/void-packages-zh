# Template file for 'wps-office-cn'
pkgname=wps-office-cn
_pkgname=wps-office
_release=11711
version=11.1.0.${_release}
revision=1
archs="x86_64 aarch64"
short_desc="Linux office suite with similar appearance to MS Office"
maintainer="mobinmob <mobinmob@disroot.org>"
# The old Kingsoft WPS Community License has disappeared from the
# site. There is an EULA in the archive which is installed as license
# and a non-downloadable EULA which is accesible from inside the program:
# https://www.wps.com/eula?distsrc=2021help&lang=en_US&version=${version}
license="custom:EULA"
homepage="https://www.wps.cn/"
changelog="https://linux.wps.cn/wpslinuxlog"

hostmakedepends="wget rpm cpio patchelf"

# allow_unknown_shlibs=yes
nodebug=yes
nostrip=yes
restricted=yes
conflicts="EternalTerminal>=0"
repository=nonfree

# The programs themselves are PIE, but the error reporter isn't :/
nopie=yes
_disturl=https://wps-linux-personal.wpscdn.cn/wps/download/ep/Linux2019/${_release}
_distTar="${_pkgname}-${version}-1.${XBPS_TARGET_MACHINE}.rpm"

do_fetch() {
	wget "${_disturl}/${_distTar}"
}

do_extract() {
	rpm2cpio ${XBPS_BUILDDIR}/${_distTar} | cpio -div
}

pre_install () {
	patchelf --replace-needed libtiff.so.5 libtiff.so.6 opt/kingsoft/wps-office/office6/{libpdfmain.so,libqpdfpaint.so,qt/plugins/imageformats/libqtiff.so,addons/pdfbatchcompression/libpdfbatchcompressionapp.so}
}

do_install() {
	cp -R ${wrksrc}/* ${DESTDIR}
}

post_install() {
	# Clean up:
	# Delete everything under /etc. It contains cron, logrotate and autostart
	# configuration for the update check and a seperate menu category for the
	# wps programs that does not work.
	rm -rf ${DESTDIR}/etc

	# Delete postinst and prerm scripts
	rm -rf ${DESTDIR}/opt/kingsoft/wps-office/INSTALL

	# Install license
	vlicense ${DESTDIR}/opt/kingsoft/wps-office/office6/mui/default/EULA_linux.html

	# Install privacy notice as documentation
	vdoc ${DESTDIR}/opt/kingsoft/wps-office/office6/mui/default/Privacy_Linux.html

	# Install third-party licenses
	vlicense ${DESTDIR}/opt/kingsoft/wps-office/office6/thirdpartylegalnotices.txt

	# Qt4
	rm -f ${DESTDIR}/opt/kingsoft/wps-office/office6/librpc{et,wps,wpp}api.so
	# systemd
	rm -f ${DESTDIR}/opt/kingsoft/wps-office/office6/libdbus-1.so*
}
